<!DOCTYPE html>
<html ng-app="idbsDemo" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header"></head>

<body ng-controller="IdbsDemoController">
	
	<div th:replace="fragments/navbar :: navbar"></div>
	
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-2">
				<div class="well">
					
				</div>
			</div>
			<div class="col-sm-10">
				<div class="well">
					<div class="row">
						<div class="col-sm-12 text-center">
							<form>
								<input type="text" value="http://localhost:8080/identity-binder/query" />
								<button type="submit" class="btn btn-primary" ng-click="getResponse()">Get token</button>
							</form>
						</div>
					</div>
					<div class="row">
						<pre>response = {{queryResponse | json}}</pre>
					</div>
				</div>
			</div>
		</div>
			
	</div>
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script src="https://code.angularjs.org/1.3.16/angular.min.js"></script>
	
	<script>
		angular.module('idbsDemo', [])
			.controller('IdbsDemoController', ['$scope', '$http', function($scope, $http) {
				$scope.authToken = '';
				$scope.queryResponse = {};
				$scope.esc = '%26';
				
				$scope.getToken = function() {
					console.log('getting token...');
					$http({method: 'POST',
						   url: 'http://localhost:8080/openid-connect-server-webapp/token',
						   headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						   //data: {client_id:'client',client_secret:'secret',grant_type:'client_credentials',scope:'org.mitre.idbind.query'}})
						   data: 'client_id=client'+$scope.esc+'client_secret=secret'+$scope.esc+'grant_type=client_credentials'+$scope.esc+'scope=org.mitre.idbind.query'})
					.success( function(res) {
						$scope.authToken = res.access_token;
						console.log(res);
					})
					.error( function(err) {
						console.log(err);
					});
				}
				
				$scope.getResponse = function() {
					$scope.getToken();
					$http({method: 'POST',
						   url: 'http://localhost:8080/identity-binder/query',
						   headers: {'Content-Type': 'application/x-www-form-urlencoded',
							         'Accept': 'application/json',
							         'Authorization': 'Bearer ' + $scope.authToken},
						   data: 'subject=90342.ASDFJWFA'})
						   //params: {issuer: 'http://localhost:8080/openid-connect-server-webapp/', subject: '90342.ASDFJWFA'}})
					.success( function(res) {
						$scope.queryResponse = res;
					});
				}
			}]);
	</script>
</body>
</html>
